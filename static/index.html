<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Chatbot TI – Hermes</title>
  <style>
:root{
  --blue:#15385B;
  --red:#D42027;
  --bg:#f2f5f9;
  --card:#ffffff;
  --border:#e5e7eb;
  --text:#0f172a;
  --muted:#475569;
  --green:#0f766e;
  --green-ink:#064e3b;
  --accent:#0ea5e9;
  --gray:#cbd5e1;
  --gray-2:#e2e8f0;
  --light-blue:#e0f2fe;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:"Segoe UI", Roboto, system-ui, -apple-system, sans-serif;
  background:var(--bg); color:var(--text);
}

.topbar{ background:var(--blue); color:#fff; padding:10px 16px; }
.brand{ display:flex; align-items:center; gap:12px; font-weight:700; letter-spacing:1px; }
.logo{ font-size:22px }
.divider{ width:2px; height:22px; background:#ffffff33; border-radius:2px }
.appname{ font-size:16px; opacity:.9 }
.redbar{ height:8px; background:linear-gradient(90deg, var(--red), #b3151a); }

.wrap{ max-width:1150px; margin:28px auto; padding:0 32px; }
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:14px;
  box-shadow:0 6px 18px rgba(0,0,0,.06);
}
.chat-card{ padding:22px 26px; }
h2{ margin:2px 0 12px; font-size:20px; color:var(--blue); }

.grid{ display:grid; grid-template-columns:1.35fr 1fr; gap:24px; }
@media (max-width: 980px){ .grid{ grid-template-columns:1fr; } }

.chat{
  border:1px solid var(--border);
  border-radius:10px;
  padding:12px;
  height:460px;
  overflow:auto;
  background:#fafafa;
  display:flex; flex-direction:column; gap:8px;
}
.msg{ 
  max-width:85%; 
  padding:10px 12px; 
  border-radius:10px; 
  line-height:1.55; 
  border:1px solid #0000;
}
.user{ margin-left:auto; background:#e7eef9; border-color:#d6e2fb; }
.bot{ margin-right:auto; background:#ecfdf5; border-color:#c8f3e8; color:var(--green-ink); }
.msg p{ margin:0 0 8px 0; }
.msg p:last-child{ margin-bottom:0; }
.msg ol, .msg ul{ margin:8px 0; padding-left:24px; }
.msg li{ margin:4px 0; }
.msg strong{ font-weight:600; color:var(--text); }

.composer{ margin-top:12px }
textarea{
  width:100%; min-height:78px; resize:vertical;
  border:1px solid var(--border); border-radius:10px;
  padding:10px 12px; font-size:15px; outline:none; background:#fff;
}
textarea:focus{ border-color:#cbd5e1; box-shadow:0 0 0 3px #60a5fa33 }
.actions{ display:flex; gap:8px; margin-top:8px }
.btn{ padding:10px 12px; border:none; border-radius:10px; cursor:pointer; font-weight:600; transition:all .2s; }
.btn-primary{ background:var(--accent); color:#fff; }
.btn-primary:hover{ background:#0284c7; transform:translateY(-1px); }
.btn-secondary{ background:#fff; color:var(--text); border:1px solid var(--border); }

.status{ margin-top:10px; font-size:14px; color:var(--muted) }
.status.ok{ color:var(--green) }
.status.err{ color:#b91c1c }
.muted{ color:var(--muted); font-size:14px; }

.modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:flex; align-items:center; justify-content:center; z-index:1000; }
.hidden{ display:none }
.modal{ width:560px; max-width:94%; background:#fff; border:1px solid var(--border); border-radius:12px; box-shadow:0 16px 40px rgba(0,0,0,.18); overflow:hidden; }
.modal-head{ background:var(--blue); color:#fff; padding:12px 14px; font-weight:700 }
.modal-body{ padding:12px 14px; color:var(--text) }
.chk{ display:flex; gap:10px; align-items:flex-start; margin:10px 0 }
.chk input{ margin-top:4px }
.inc-title{ font-weight:700; color:var(--blue) }
.inc-desc{ opacity:.9; margin-top:3px }
.modal-actions{ display:flex; gap:8px; justify-content:flex-end; padding:10px 14px; border-top:1px solid var(--border) }
.field{ display:flex; flex-direction:column; gap:6px; margin-top:12px }
.field input{ width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; }

.status-card{ padding:28px 34px; }
.followup{ display:flex; gap:10px; align-items:center; margin-top:16px; }
.refbox{ flex:1; padding:12px 14px; border:1px solid var(--border); border-radius:12px; outline:none; background:#fff; font-size:15px; transition:all .2s; }
.refbox:focus{ border-color:var(--accent); box-shadow:0 0 0 3px #60a5fa33 }

/* === Tracker Visual Mejorado === */
.ticket-summary{
  margin:24px 0 0 0;
  border:1px solid var(--border);
  border-radius:16px;
  background:#fff;
  padding:28px 32px;
  box-shadow:0 4px 16px rgba(0,0,0,.04);
  animation:fadeIn .4s ease;
}

@keyframes fadeIn{
  from{ opacity:0; transform:translateY(10px); }
  to{ opacity:1; transform:translateY(0); }
}

.ticket-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding-bottom:20px;
  border-bottom:2px solid var(--gray-2);
  margin-bottom:24px;
}

.ticket-ref{
  display:flex;
  align-items:center;
  gap:12px;
}

.ref-badge{
  background:linear-gradient(135deg, var(--blue), #1e5a8e);
  color:#fff;
  padding:8px 16px;
  border-radius:10px;
  font-weight:700;
  font-size:18px;
  letter-spacing:0.5px;
  box-shadow:0 4px 12px rgba(21,56,91,.25);
}

.ticket-title-main{
  font-size:16px;
  color:var(--text);
  font-weight:600;
  max-width:450px;
}

.status-badge{
  padding:8px 18px;
  border-radius:20px;
  font-weight:600;
  font-size:13px;
  text-transform:uppercase;
  letter-spacing:0.5px;
}

.status-new{ background:#e0f2fe; color:#0369a1; }
.status-assigned{ background:#dbeafe; color:#1e40af; }
.status-pending{ background:#fef3c7; color:#b45309; }
.status-waiting_for_approval{ background:#fce7f3; color:#a21caf; }
.status-resolved{ background:#d1fae5; color:#065f46; }
.status-closed{ background:#e5e7eb; color:#374151; }

/* Tracker de Progreso */
.progress-tracker{
  margin:32px 0;
  position:relative;
}

.tracker-line-container{
  position:relative;
  height:4px;
  background:var(--gray-2);
  border-radius:4px;
  margin:0 40px 40px 40px;
  overflow:hidden;
}

.tracker-line-fill{
  height:100%;
  background:linear-gradient(90deg, var(--accent), #0284c7);
  border-radius:4px;
  transition:width .8s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow:0 2px 8px rgba(14,165,233,.4);
}

.tracker-steps{
  display:flex;
  justify-content:space-between;
  position:relative;
}

.tracker-step{
  flex:1;
  display:flex;
  flex-direction:column;
  align-items:center;
  position:relative;
}

.step-dot{
  width:40px;
  height:40px;
  border-radius:50%;
  background:#fff;
  border:3px solid var(--gray);
  display:flex;
  align-items:center;
  justify-content:center;
  position:relative;
  z-index:2;
  transition:all .4s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow:0 4px 12px rgba(0,0,0,.08);
}

.tracker-step.done .step-dot,
.tracker-step.current .step-dot{
  border-color:var(--accent);
  background:linear-gradient(135deg, var(--light-blue), #e0f2fe);
  box-shadow:0 6px 20px rgba(14,165,233,.3);
  transform:scale(1.1);
}

.tracker-step.current .step-dot{
  animation:pulse 2s infinite;
}

@keyframes pulse{
  0%, 100%{ box-shadow:0 6px 20px rgba(14,165,233,.3); }
  50%{ box-shadow:0 8px 28px rgba(14,165,233,.5); }
}

.step-dot svg{
  display:none;
  width:20px;
  height:20px;
}

.tracker-step.done .step-dot svg{
  display:block;
  stroke:var(--accent);
}

.tracker-step.current .step-dot::after{
  content:'';
  width:12px;
  height:12px;
  background:var(--accent);
  border-radius:50%;
  animation:pulseInner 1.5s infinite;
}

@keyframes pulseInner{
  0%, 100%{ transform:scale(1); opacity:1; }
  50%{ transform:scale(1.3); opacity:.7; }
}

.step-label{
  margin-top:12px;
  font-size:12px;
  font-weight:500;
  color:var(--muted);
  text-align:center;
  max-width:100px;
  line-height:1.3;
  transition:all .3s;
}

.tracker-step.done .step-label,
.tracker-step.current .step-label{
  color:var(--blue);
  font-weight:700;
}

/* Detalles del Ticket */
.ticket-details{
  display:grid;
  grid-template-columns:repeat(2, 1fr);
  gap:20px 32px;
  margin-top:28px;
}

.detail-item{
  display:flex;
  flex-direction:column;
  gap:6px;
}

.detail-label{
  font-size:12px;
  color:var(--muted);
  text-transform:uppercase;
  letter-spacing:0.5px;
  font-weight:600;
}

.detail-value{
  font-size:15px;
  color:var(--text);
  font-weight:500;
  line-height:1.4;
}

.detail-item.full{
  grid-column:1 / -1;
}

.priority-badge{
  display:inline-block;
  padding:4px 12px;
  border-radius:6px;
  font-size:13px;
  font-weight:600;
}

.priority-high{ background:#fee2e2; color:#991b1b; }
.priority-medium{ background:#fef3c7; color:#b45309; }
.priority-low{ background:#dbeafe; color:#1e40af; }

@media (max-width:780px){
  .ticket-details{ grid-template-columns:1fr; gap:16px; }
  .tracker-steps{ gap:4px; }
  .step-label{ font-size:10px; max-width:70px; }
  .ticket-header{ flex-direction:column; align-items:flex-start; gap:12px; }
}

@media (max-width:640px){
  .chat{ height:60vh }
  .ticket-summary{ padding:20px 16px; }
}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo">HERMES</div>
      <div class="divider"></div>
      <div class="appname">Chatbot TI</div>
    </div>
  </header>
  <nav class="redbar"></nav>

  <main class="wrap">
    <div class="grid">
      <section class="card chat-card">
        <h2>Asistencia TI</h2>
        <div id="chat" class="chat"></div>

        <div class="composer">
          <textarea id="input" placeholder="Escribe tu consulta y presiona Enter… (Shift+Enter para salto de línea)"></textarea>
          <div class="actions">
            <button id="ticketBtn" class="btn btn-primary">Crear ticket iTop</button>
          </div>
        </div>

        <div id="status" class="status"></div>
      </section>

      <section class="card status-card">
        <h2>Seguimiento de Ticket</h2>
        <p class="muted">Consulta el estado de tu ticket ingresando la referencia (p. ej. <b>R-058228</b>).</p>

        <div class="followup">
          <input id="refInput" type="text" class="refbox" placeholder="R-000000" />
          <button id="refBtn" class="btn btn-primary">Consultar</button>
        </div>

        <div id="refStatus" class="status"></div>
        <div id="ticketSummary" class="ticket-summary hidden"></div>
      </section>
    </div>
  </main>

  <div id="incModal" class="modal-backdrop hidden">
    <div class="modal">
      <div class="modal-head">Selecciona los incidentes a enviar como ticket</div>
      <div class="modal-body">
        <p class="inc-desc">Marca uno o varios. Puedes revisar los títulos y descripciones detectadas.</p>
        <div id="incList"></div>

        <div class="field">
          <label for="emailBox">Correo corporativo</label>
          <input id="emailBox" type="email" placeholder="nombre.apellido@hermes.com.pe" />
        </div>
      </div>
      <div class="modal-actions">
        <button id="incCancel" class="btn btn-secondary">Cancelar</button>
        <button id="incConfirm" class="btn btn-primary">Crear ticket(s)</button>
      </div>
    </div>
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const chat      = document.getElementById("chat");
    const input     = document.getElementById("input");
    const statusBox = document.getElementById("status");
    const ticketBtn = document.getElementById("ticketBtn");

    const incModal   = document.getElementById("incModal");
    const incList    = document.getElementById("incList");
    const incCancel  = document.getElementById("incCancel");
    const incConfirm = document.getElementById("incConfirm");
    const emailBox   = document.getElementById("emailBox");

    const refInput      = document.getElementById("refInput");
    const refBtn        = document.getElementById("refBtn");
    const refStatus     = document.getElementById("refStatus");
    const ticketSummary = document.getElementById("ticketSummary");

    let sessionId = localStorage.getItem("session_id") || null;

    const STATUS_ORDER = ["new","assigned","pending","waiting_for_approval","resolved","closed"];
    const STATUS_LABEL = {
      new: "Nuevo",
      assigned: "Asignado",
      pending: "Pendiente",
      waiting_for_approval: "En espera de aprobación",
      resolved: "Resuelto",
      closed: "Cerrado",
    };

    function sanitize(t){ return (t||"").toString().replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
    function showStatus(elem, msg, ok=true){ elem.textContent = msg; elem.className = "status " + (ok ? "ok" : "err"); }

    // Mejorado: convierte texto a HTML con formato
    function formatBotMessage(text) {
      if (!text) return "";
      
      let html = sanitize(text);
      
      // Detectar listas numeradas con formato: 1. **Titulo** resto
      const hasNumberedList = /^\d+\.\s+\*\*[^*]+\*\*/m.test(html);
      
      if (hasNumberedList) {
        // Convertir líneas numeradas en items de lista
        const lines = html.split('\n');
        let inList = false;
        let result = '';
        
        lines.forEach(line => {
          const numberedMatch = line.match(/^(\d+)\.\s+\*\*([^*]+)\*\*(.*)$/);
          if (numberedMatch) {
            if (!inList) {
              result += '<ol>';
              inList = true;
            }
            result += `<li><strong>${numberedMatch[2]}</strong>${numberedMatch[3]}</li>`;
          } else {
            if (inList && line.trim()) {
              result += '</ol>';
              inList = false;
            }
            if (line.trim()) {
              result += `<p>${line}</p>`;
            }
          }
        });
        
        if (inList) result += '</ol>';
        html = result;
      } else {
        // Detectar listas con viñetas
        const hasBulletList = /^[•\-]\s+/m.test(html);
        
        if (hasBulletList) {
          const lines = html.split('\n');
          let inList = false;
          let result = '';
          
          lines.forEach(line => {
            const bulletMatch = line.match(/^[•\-]\s+(.+)$/);
            if (bulletMatch) {
              if (!inList) {
                result += '<ul>';
                inList = true;
              }
              result += `<li>${bulletMatch[1]}</li>`;
            } else {
              if (inList && line.trim()) {
                result += '</ul>';
                inList = false;
              }
              if (line.trim()) {
                result += `<p>${line}</p>`;
              }
            }
          });
          
          if (inList) result += '</ul>';
          html = result;
        } else {
          // No es lista: convertir saltos de línea a párrafos
          const paragraphs = html.split('\n\n');
          html = paragraphs.map(p => {
            const cleaned = p.replace(/\n/g, '<br>').trim();
            return cleaned ? `<p>${cleaned}</p>` : '';
          }).join('');
        }
      }
      
      // Procesar negritas **texto**
      html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
      
      return html;
    }

    function renderMessage(text, cls){
      const msg = document.createElement("div");
      msg.className = "msg " + cls;
      
      if (cls === "bot") {
        msg.innerHTML = formatBotMessage(text);
      } else {
        msg.innerHTML = `<p>${sanitize(text)}</p>`;
      }
      
      chat.appendChild(msg);
      chat.scrollTop = chat.scrollHeight;
    }

    async function sendQuestion(q){
      renderMessage(q, "user");
      showStatus(statusBox, "Consultando…");
      try{
        const r = await fetch("/api/ask", {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({question:q, session_id: sessionId})
        });
        if (r.status === 204){ showStatus(statusBox, "Listo."); return; }
        const data = await r.json();
        if(r.ok){
          if (data.session_id){ sessionId = data.session_id; localStorage.setItem("session_id", sessionId); }
          renderMessage(data.answer || "Sin respuesta", "bot");
          showStatus(statusBox, "Listo.");
        } else {
          showStatus(statusBox, "Error: " + (data.error || "Desconocido"), false);
        }
      }catch(e){ showStatus(statusBox, "Error de red: " + e, false); }
    }

    input.addEventListener("keydown", (e)=>{
      if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); const q=input.value.trim(); if(q){ sendQuestion(q); input.value=""; } }
    });

    async function fetchIncidents(){
      if(!sessionId){ showStatus(statusBox,"Primero realiza una consulta para iniciar sesión.", false); return []; }
      try{
        const r = await fetch("/api/incidents",{ method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({session_id:sessionId})});
        const d = await r.json(); return r.ok ? (d.incidents||[]) : [];
      }catch(_){ return []; }
    }

    function openIncidentModal(list){
      incList.innerHTML = "";
      if(!list.length){ incList.innerHTML = `<p class="inc-desc">No se detectaron incidentes.</p>`; }
      else{
        list.forEach((inc,idx)=>{
          const wrap = document.createElement("div");
          wrap.className = "chk";
          wrap.innerHTML = `
            <input type="checkbox" id="inc_${idx}" data-index="${idx}" checked />
            <label for="inc_${idx}">
              <div class="inc-title">${sanitize(inc.title||"Incidente")}</div>
              <div class="inc-desc">${sanitize(inc.description||"")}</div>
            </label>`;
          incList.appendChild(wrap);
        });
      }
      emailBox.value = localStorage.getItem("email_corporativo") || "";
      incModal.classList.remove("hidden");
    }

    function closeIncidentModal(){ incModal.classList.add("hidden"); }

    ticketBtn.onclick = async ()=>{ showStatus(statusBox,"Analizando conversación…"); const incs=await fetchIncidents(); showStatus(statusBox,"Listo."); openIncidentModal(incs); };
    incCancel.onclick = ()=> closeIncidentModal();
    incConfirm.onclick = async ()=>{
      const email = (emailBox.value||"").trim();
      if(!email){ showStatus(statusBox, "Correo requerido.", false); emailBox.focus(); return; }
      localStorage.setItem("email_corporativo", email);
      const indexes = Array.from(incList.querySelectorAll("input[type=checkbox]")).filter(c=>c.checked).map(c=>parseInt(c.dataset.index,10));
      if(!indexes.length){ showStatus(statusBox, "Selecciona al menos un incidente.", false); return; }
      showStatus(statusBox,"Creando ticket(s) …");
      try{
        const r = await fetch("/api/create_ticket",{method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({email, session_id:sessionId, indexes})});
        const d = await r.json();
        if(r.ok && d.ok){ const refs=(d.results||[]).map(x=>x.ref||"(sin ref)").join(", "); showStatus(statusBox,`Ticket(s) ${refs} enviados a ${email}.`,true); closeIncidentModal(); }
        else{ showStatus(statusBox,"Error: " + (d.error || JSON.stringify(d)), false); }
      }catch(e){ showStatus(statusBox,"Error de red: " + e, false); }
    };

    refBtn.onclick = consultTicket;
    refInput.addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); consultTicket(); }});

    async function consultTicket(){
      const ref = (refInput.value||"").trim();
      ticketSummary.classList.add("hidden"); ticketSummary.innerHTML = "";
      if(!ref){ showStatus(refStatus,"Ingresa la referencia del ticket (p. ej. R-058228)", false); return; }
      showStatus(refStatus,"Consultando iTop…");
      try{
        const r = await fetch("/api/ticket_status",{ method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({ref})});
        const d = await r.json();
        if(!r.ok || !d.ok){ showStatus(refStatus, d.error || "No se encontró el ticket", false); return; }
        showStatus(refStatus,"Listo.");
        renderTicketSummary(d.fields);
      }catch(e){ showStatus(refStatus,"Error de red: " + e, false); }
    }

    function renderTicketSummary(f){
      const fmt = (s)=> sanitize(s||"—");
      const rawStatus = (f.status||"").toLowerCase();
      const statusLabel = STATUS_LABEL[rawStatus] || fmt(f.status||"");
      const activeIdx = Math.max(0, STATUS_ORDER.indexOf(rawStatus));
      
      const priorityClass = (f.priority||"").toLowerCase().includes("high") ? "priority-high" : 
                           (f.priority||"").toLowerCase().includes("low") ? "priority-low" : "priority-medium";

      ticketSummary.innerHTML = `
        <div class="ticket-header">
          <div class="ticket-ref">
            <div class="ref-badge">${fmt(f.ref)}</div>
            <div class="ticket-title-main">${fmt(f.title)}</div>
          </div>
          <div class="status-badge status-${rawStatus}">${statusLabel}</div>
        </div>

        ${buildProgressTracker(activeIdx)}

        <div class="ticket-details">
          <div class="detail-item">
            <div class="detail-label">Servicio</div>
            <div class="detail-value">${fmt(f.service_id_friendlyname)}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Subcategoría</div>
            <div class="detail-value">${fmt(f.servicesubcategory_id_friendlyname)}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Equipo</div>
            <div class="detail-value">${fmt(f.team_id_friendlyname)}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Agente Asignado</div>
            <div class="detail-value">${fmt(f.agent_id_friendlyname)}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Solicitante</div>
            <div class="detail-value">${fmt(f.caller_id_friendlyname)}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Prioridad</div>
            <div class="detail-value"><span class="priority-badge ${priorityClass}">${fmt(f.priority)}</span></div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Urgencia</div>
            <div class="detail-value">${fmt(f.urgency)}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Impacto</div>
            <div class="detail-value">${fmt(f.impact)}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Fecha Inicio</div>
            <div class="detail-value">${fmt(f.start_date)}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Última Actualización</div>
            <div class="detail-value">${fmt(f.last_update)}</div>
          </div>
          ${f.close_date ? `
          <div class="detail-item">
            <div class="detail-label">Fecha Cierre</div>
            <div class="detail-value">${fmt(f.close_date)}</div>
          </div>` : ''}
          ${f.resolution_code ? `
          <div class="detail-item full">
            <div class="detail-label">Código de Resolución</div>
            <div class="detail-value">${fmt(f.resolution_code)}</div>
          </div>` : ''}
        </div>
      `;

      ticketSummary.classList.remove("hidden");
      ticketSummary.scrollIntoView({behavior:"smooth", block:"nearest"});
    }

    function buildProgressTracker(activeIdx){
      const progressPct = (activeIdx / (STATUS_ORDER.length - 1)) * 100;
      
      const steps = STATUS_ORDER.map((key, idx) => {
        const label = STATUS_LABEL[key];
        const state = idx < activeIdx ? "done" : (idx === activeIdx ? "current" : "todo");
        
        return `
          <div class="tracker-step ${state}">
            <div class="step-dot">
              <svg viewBox="0 0 24 24" fill="none" stroke-width="3">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
            </div>
            <div class="step-label">${sanitize(label)}</div>
          </div>
        `;
      }).join("");

      return `
        <div class="progress-tracker">
          <div class="tracker-line-container">
            <div class="tracker-line-fill" style="width:${progressPct}%;"></div>
          </div>
          <div class="tracker-steps">${steps}</div>
        </div>
      `;
    }
  });
  </script>
</body>
</html>